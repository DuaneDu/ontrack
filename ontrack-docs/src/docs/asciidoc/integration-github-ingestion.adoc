[[integration-github-ingestion]]
=== GitHub Ingestion

In addition to Ontrack being able to <<integration-github,interact with GitHub>>, it is also possible to set up a https://docs.github.com/en/developers/webhooks-and-events/webhooks/about-webhooks[webhook] in GitHub so that data from GitHub Actions workflows is automatically ingested by Ontrack, without having the workflows being adapted in any way. This allows for a seamless integration between GitHub Actions workflows and Ontrack.

[[integration-github-ingestion-features]]
==== GitHub ingestion features

When a workflow runs, the following items are created or updates in Ontrack.

The project in Ontrack will be called like the _repository_, adjusted for Ontrack naming conventions for entities. It'll be associated with the first matching GitHub configuration. Optionally, the organization name can be set as a prefix to the project names using the <<integration-github-ingestion-settings,global settings>>.

The branch is Ontrack will be called according the head branch (or the PR name) and its Git branch will also be set.

The build is created by aggregating the workflow name and the run number. Additionally, the following properties are set:

* the Git commit property
* the run info

Validation stamps are created using `<job>-<step>`, adjusted for the Ontrack naming convventions.

Builds and validation runs are associated with properties & decorations linking to the source workflow run in GitHub.

The creation of the validation runs occurs as the workflow run is in progress, allowing Ontrack to collect information as it goes.

[[integration-github-ingestion-setup-ontrack]]
==== Ontrack setup

At least one <<integration-github,GitHub configuration>> must be created.

The communication between GitHub and Ontrack is secured through a specific token, outside the Ontrack normal authentication mechanisms.

This secret can be generated by using:

[source,bash]
----
ruby -rsecurerandom -e 'puts SecureRandom.hex(20)'
----

but other ways are also acceptable.

In the _Settings_, go to the _GitHub workflow ingestion_ section and set the token as previously generated.

[[integration-github-ingestion-setup-github]]
==== GitHub setup

In GitHub, the Ontrack ingestion hook can be setup at repository or at organization level.

Go to the _Settings > Webhooks_ section and add a new webhook:

* URL - `<ontrack>/hook/secured/github/ingestion`
* Content type - `application/json`
* Secret - the secret you generated in the <<integration-github-ingestion-setup-ontrack>>
* Permissions:
** Workflow jobs
** Workflow runs
** Pushes (for autoconfiguration, see later)

[[integration-github-ingestion-settings]]
==== General settings

In the _Settings > GitHub workflow ingestion_ section, you can configure the following features:

* the secret token used by the GitHub hook
* the number of days GitHub hook payloads are kept by Ontrack
* if the organization name must be used as a prefix for the generated project names

[[integration-github-ingestion-management]]
==== Management

The Ontrack hook receives all registered GitHub event payloads. The latter are processed in a queue and then kept for investigation and inspection.

[NOTE]
====
The payloads whose signature cannot be be checked or is not OK are not stored.
====

The number of days these payloads are kept is configured in the <<integration-github-ingestion-settings,global settings>>.

An Ontrack administrator can access the list of payloads using the _GitHub Ingestion Hook Payloads_ user menu:

image::images/integration-github-ingestion-management-list.png[Payload list]

The _Auto refresh_ button allows the content of the payload list to be automatically refreshed every 10 seconds. The settings are saved in the browser local storage.

The list can be filtered using the following arguments:

* the processing statuses:
** `SCHEDULED` - the payload has been received and queued for later processing.
** `PROCESSING` - the payload is currently being processed. Some Ontrack elements may have already been created.
** `ERRORED` - the processing failed. The payload entry in the list will have an explanation.
** `COMPLETED` - the processing of the payload completed successfully.
* the GitHub Delivery ID - each event payload sent by GitHub is associated with a unique delivery ID.
* the GitHub event - the event which sent the payload

By clicking on the internal Ontrack ID (leftmost column), you can display for information about the payload, including its complete JSON content:

image::images/integration-github-ingestion-management-details.png[Payload details]

[[integration-github-ingestion-metrics]]
==== Metrics

The following metric is exported to track the number of calls received where the security signature does not match:

* `ontrack_extension_github_ingestion_signature_error_count` - the `event` tag contains the GitHub event

The following processing metrics are exported by Ontrack:

* `ontrack_extension_github_ingestion_received_count` - number of payloads being received
* `ontrack_extension_github_ingestion_processing_started_count` - number of payloads whose processing has started
* `ontrack_extension_github_ingestion_processing_success_count` - number of payloads whose processing has completed successfully
* `ontrack_extension_github_ingestion_processing_error_count` - number of payloads whose processing has failed
* `ontrack_extension_github_ingestion_processing_finished_count` - number of payloads whose processing has completed, with an error or not
* `ontrack_extension_github_ingestion_processing_time` - timer (in milliseconds) for the processing times

All the processing metrics have the `event` tag attached.
