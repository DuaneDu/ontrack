buildscript {
    repositories {
        mavenLocal() // Important: used for testing
        mavenCentral()
        jcenter()
        maven {
            url "https://plugins.gradle.org/m2/"
        }
    }
    dependencies {
        classpath "net.nemerosa.ontrack:ontrack-extension-plugin:${ontrackVersion}"
    }
}

plugins {
    id 'com.bmuschko.docker-remote-api' version '4.1.0'
}

group = 'net.nemerosa.ontrack'
version = ontrackVersion

repositories {
    mavenLocal() // Important: used for testing
    mavenCentral()
    jcenter()
}

apply plugin: 'ontrack'

ontrack {
    kotlin()
}

dependencies {
    compileOnly 'org.projectlombok:lombok:1.16.18'

    // Test for 3rd party dependencies not included in Ontrack core runtime
    compile 'org.apache.commons:commons-math3:3.6.1'

    testCompile "net.nemerosa.ontrack:ontrack-acceptance:${ontrackVersion}"
    testCompile "net.nemerosa.ontrack:ontrack-dsl:${ontrackVersion}"
}

import com.bmuschko.gradle.docker.tasks.image.DockerBuildImage
import org.apache.tools.ant.filters.ReplaceTokens

task prepareDockerImage(type: Copy) {
    dependsOn ontrackDist
    from('build/dist') {
        include '*.jar'
    }
    from('src/main/docker') {
        include '*.yml'
        include 'Dockerfile'
        filter(ReplaceTokens, tokens: [
                ontrackVersion: ontrackVersion,
        ])
    }
    into project.file('build/docker')
}

task buildDockerImage(type: DockerBuildImage) {
    dependsOn prepareDockerImage
    inputDir.set(project.file('build/docker'))
    tags.add("nemerosa/ontrack-extension-test:${version}")
}

assemble.dependsOn buildDockerImage
