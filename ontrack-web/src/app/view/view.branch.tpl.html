<ot-view>

    <div class="row" ng-show="loadingBranch">
        <div class="col-md-12">
            <div class="alert alert-info">
                Loading the branch...
            </div>
        </div>
    </div>

    <div class="row" ng-if="branch">
        <div class="col-md-12 ot-view-title">
            <span id="ot-view-title">{{branch.name}}</span>
            <ot-entity-embedded-decorations decorations="branch.decorations"></ot-entity-embedded-decorations>
            <div ng-if="branch.description" class="ot-description" ng-bind-html="branch.description"></div>
        </div>
    </div>

    <table class="ot-branch-build-view">
        <thead>
        <tr>
            <!-- Filters, loading, ... --->
            <th colspan="2">
                <!-- Auto refresh flag -->
                <button class="ot-branch-build-view-auto-refresh"
                        ng-class="{
                            'ot-branch-build-view-auto-refresh-enabled': autoRefresh,
                            'ot-branch-build-view-auto-refresh-disabled': !autoRefresh
                            }"
                        title="{{autoRefresh ? 'Auto refresh is enabled' : 'Auto refresh is disabled'}}"
                        ng-click="toggleAutoRefresh()">
                    <span class="fa fa-refresh"></span>
                </button>
                <!-- Loading indicator for the builds -->
                <button ng-show="loadingBuilds" class="btn btn-default" disabled="disabled">
                    <span class="ot-loading-indicator"></span>
                    Loading builds...
                </button>
            </th>
            <!-- Validation stamps -->
            <th ng-repeat="validationStamp in validationStamps | filter:validationStampFilterFn"
                class="ot-branch-build-view-validation"
                >
<!--                TODO VS names -->
<!--                ng-style="{-->
<!--                    height: validationStampFilterNameMaxHeight()-->
<!--                }"-->
<!--                TODO VS names & VS filter -->
<!--                ng-class="{-->
<!--                    'ot-validation-stamp-filter-edition': validationStampFilter && validationStampFilter._update && validationStampFilterEdition,-->
<!--                    'ot-branch-build-view-validation-name-rotated': user.preferences.branchViewVsNames-->
<!--                }"-->
                <div>
                    <!-- TODO VS filter edition ON -->
<!--                    <span ng-if="validationStampFilter && validationStampFilter._update && validationStampFilterEdition">-->
<!--                        <span class="ot-action"-->
<!--                              ng-class="{-->
<!--                                'ot-validation-stamp-filter-edition-selected': validationStampFilter.vsNames.indexOf(validationStamp.name) >= 0,-->
<!--                                'ot-validation-stamp-filter-edition-unselected': validationStampFilter.vsNames.indexOf(validationStamp.name) < 0-->
<!--                                }"-->
<!--                              ng-click="toggleValidationStampFromFilter(validationStamp.name)"-->
<!--                        >-->
<!--                            <ot-entity-image entity="validationStamp"><span ng-show="user.preferences.branchViewVsNames">{{ validationStampFilterNameElapsed(validationStamp.name) }}</span></ot-entity-image>-->
<!--                        </span>-->
<!--                        <span-->
<!--                                ng-if="validationStampFilter && validationStampFilter._update && validationStampFilterEdition && validationStampFilter.vsNames.indexOf(validationStamp.name) >= 0"-->
<!--                                ng-click="removeValidationStampFromFilter(validationStampFilter, validationStamp.name)"-->
<!--                                title="Removes the {{validationStamp.name}} validation stamp from the {{validationStampFilter.name}} filter"-->
<!--                                class="fa fa-minus-circle text-danger ot-action"-->
<!--                                style="font-size: 50%; vertical-align: bottom;"></span>-->
<!--                        <span-->
<!--                                ng-if="validationStampFilter && validationStampFilter._update && validationStampFilterEdition && validationStampFilter.vsNames.indexOf(validationStamp.name) < 0"-->
<!--                                ng-click="addValidationStampFromFilter(validationStampFilter, validationStamp.name)"-->
<!--                                title="Adds the {{validationStamp.name}} validation stamp from the {{validationStampFilter.name}} filter"-->
<!--                                class="fa fa-plus-circle text-success ot-action"-->
<!--                                style="font-size: 50%; vertical-align: bottom;"></span>-->
<!--                    </span>-->
                    <!-- TODO VS filter edition OFF -->
<!--                    <span ng-if="!validationStampFilter || !validationStampFilter._update || !validationStampFilterEdition">-->
                        <ot-entity-image entity="validationStamp"
                                         title="{{validationStamp.name}} - {{validationStamp.description}}"
                                         link="#/validationStamp/{{validationStamp.id}}"><span ng-show="user.preferences.branchViewVsNames">{{ validationStampFilterNameElapsed(validationStamp.name) }}</span></ot-entity-image>
<!--                    </span>-->
                </div>
            </th>
        </tr>
        </thead>
        <tbody>
        <tr ng-repeat="build in builds">
            <!-- Build name column -->
            <td>
                <!-- Build name and link -->
                <a href="#/build/{{build.id}}" class="ot-branch-build-view-build-name">
                    {{build.name}}
                </a>
                <!-- Build decorations -->
                <span class="ot-decoration-list">
                    <ot-entity-embedded-decorations decorations="build.decorations"></ot-entity-embedded-decorations>
                </span>
                <!-- Signature, without the creator in the overview -->
                <div class="ot-branch-build-view-build-signature">
                    {{build.creation.time | date:'mediumDate'}}
                    {{build.creation.time | date:'shortTime'}}
                </div>
            </td>
            <!-- Promotion runs -->
            <td>
                <span ng-repeat="promotionRun in build.promotionRuns">
                    <span class="ot-promotion-run">
                        <span class="ot-action"
                              ng-click="displayPromotionRuns(build, promotionRun)">
                            <ot-entity-image
                                    title="{{promotionRun.promotionLevel.name}} - {{promotionRun.creation.time | date:'shortDate'}}"
                                    entity="promotionRun.promotionLevel"></ot-entity-image>
                        </span>
                    </span>
                </span>
            </td>
            <!-- Validation runs -->
            <td ng-repeat="validation in build.validations | filter:validationStampRunViewFilter"
                class="ot-branch-build-view-validation">
                <!-- Not run and validation enabled -->
                <span id="validation-{{build.id}}-{{validation.validationStamp.id}}-validate" ng-if="validation.validationRuns.length == 0 && build.links._validate" class="ot-command"
                      ng-click="createValidationRun(build, validation.validationStamp)">
                    <ot-validation-run-status-none></ot-validation-run-status-none>
                </span>
                    <!-- Not run and validation not enabled -->
                    <span id="validation-{{build.id}}-{{validation.validationStamp.id}}-none" ng-if="validation.validationRuns.length == 0 && !build.links._validate">
                    <ot-validation-run-status-none></ot-validation-run-status-none>
                </span>
                    <!-- Last status -->
                    <span id="validation-{{build.id}}-{{validation.validationStamp.id}}-list" ng-if="validation.validationRuns.length > 0">
                    <span class="ot-action" ng-click="displayValidationRuns(build, validation.validationStamp)">
                        <ot-validation-run-status status="validation.validationRuns[0].validationRunStatuses[0]"></ot-validation-run-status>
                    </span>
                </span>
            </td>
        </tr>
        <tr ng-if="buildsPageInfo.nextPage">
            <td colspan="0">
                <button type="button" class="ot-branch-build-view-more" title="Displays more builds." ng-click="loadMoreBuilds()">
                    More...
                </button>
            </td>
        </tr>
        </tbody>
    </table>

</ot-view>